<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tax Return FY25-26 Work Log</title>
    <style>
        /* Base & layout */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }

        /* Summary cards */
        .summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card {
            background: #3498db;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }
        .summary-card:hover {
            transform: scale(1.05);
            background-color: #5dade2;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .summary-card h3 { margin: 0 0 10px; font-size: 16px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .summary-card .value { font-size: 28px; font-weight: 700; }

        /* Controls */
        .controls { text-align: center; margin-bottom: 20px; }
        button {
            margin: 0 8px;
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        button:hover { transform: translateY(-1px); }
        .regen-btn { background: #2ecc71; color: #fff; }
        .regen-btn:hover { background: #27ae60; }
        .import-btn { background: #3498db; color: #fff; }
        .import-btn:hover { background: #2980b9; }
        .export-btn { background: #e74c3c; color: #fff; }
        .export-btn:hover { background: #c0392b; }
        .clear-btn { background: #f39c12; color: #fff; }
        .clear-btn:hover { background: #e67e22; }
        .save-btn { background: #9b59b6; color: #fff; }
        .save-btn:hover { background: #8e44ad; }

        /* Responsive controls */
        @media (max-width: 600px) {
            .controls { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
            button { margin: 0; flex: 1; min-width: 120px; }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .modal h3 { color: #333; margin-bottom: 15px; }
        .modal p { color: #666; margin-bottom: 25px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
        .confirm-btn { background: #e74c3c; color: white; }
        .confirm-btn:hover { background: #c0392b; }
        .cancel-btn { background: #95a5a6; color: white; }
        .cancel-btn:hover { background: #7f8c8d; }

        /* Table */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 700px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tbody tr:not(.month-header):hover td {
            background-color: #f9f9f9;
        }
        td input, td select {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            padding: 4px;
            font-size: 14px;
        }
        td input:focus, td select:focus {
            outline: 2px solid #3498db;
            background: white;
            border-radius: 3px;
        }

        /* Row classes */
        .wfh          { background-color: #e8f5e8; }
        .client       { background-color: #fff3cd; }
        .holiday      { background-color: #ffebee; color: #d32f2f; }
        .annual-leave { background-color: #d1ecf1; color: #0c5460; }

        /* Month header & totals */
        .month-header { background: #2980b9; color: #fff; font-weight: 600; font-size: 16px; }
        .totals-row   { background: #ecf0f1; font-weight: 600; }

        /* Debug info */
        .debug { margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-family: monospace; font-size: 12px; }

        /* Status indicator */
        .status { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            padding: 8px 12px; 
            border-radius: 5px; 
            font-size: 12px; 
            font-weight: 500; 
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .status.show { opacity: 1; }
        .status.success { background: #2ecc71; color: white; }
        .status.error { background: #e74c3c; color: white; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container { padding: 15px; margin: 10px; }
            .summary { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .summary-card { padding: 15px; }
            .summary-card .value { font-size: 24px; }
            table { font-size: 12px; }
            th, td { padding: 6px 4px; }
            .modal-content { margin: 20% auto; padding: 20px; }
        }
    </style>
</head>
<body>
  <div class="container">
    <h1>FY25-26 Work Log</h1>
    <div class="summary">
      <div class="summary-card"><h3>Total WFH Hours</h3><div class="value" id="totalWfh">0</div></div>
      <div class="summary-card"><h3>Client Visits</h3><div class="value" id="totalVisits">0</div></div>
      <div class="summary-card"><h3>Total KM Travelled</h3><div class="value" id="totalKm">0 km</div></div>
      <div class="summary-card"><h3>Working Days</h3><div class="value" id="totalDays">0</div></div>
    </div>
    <div class="controls">
      <button class="regen-btn" onclick="regenerate()">Regenerate</button>
      <button class="clear-btn" onclick="showClearModal()">Clear All</button>
      <button class="import-btn" onclick="document.getElementById('csvFile').click()">Import CSV</button>
      <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="importCSV(event)" />
      <button class="export-btn" onclick="exportCSV()">Export CSV</button>
      <button class="save-btn" onclick="saveToFile()">Save File</button>
    </div>
    
    <!-- Status indicator -->
    <div id="status" class="status"></div>
    
    <!-- Clear Confirmation Modal -->
    <div id="clearModal" class="modal">
      <div class="modal-content">
        <h3>Clear All Data?</h3>
        <p>This will remove all entered data and reset the work log to empty entries with only public holidays pre-filled. This action cannot be undone.</p>
        <div class="modal-buttons">
          <button class="confirm-btn" onclick="confirmClear()">Clear All</button>
          <button class="cancel-btn" onclick="hideClearModal()">Cancel</button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr><th>Date</th><th>Day</th><th>Type</th><th>WFH Hours</th><th>Travel KM</th><th>Notes</th></tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
    <div class="debug" id="debug" style="display:none;"></div>
  </div>
  
  <!-- PERSISTENT DATA STORAGE -->
  <script type="application/json" id="workLogData">
  {"work":[],"isFirstLoad":true}
  </script>
  
  <script>
    // NSW holidays for FY25-26 (July 1, 2025 - June 30, 2026)
    const nswHolidays = new Set([
      // 2025 holidays in FY25-26
      '2025-08-04', // Bank Holiday (First Monday in August)
      '2025-10-06', // Labour Day (First Monday in October)
      '2025-12-25', // Christmas Day
      '2025-12-26', // Boxing Day
      // 2026 holidays in FY25-26
      '2026-01-01', // New Year's Day
      '2026-01-26', // Australia Day
      '2026-04-03', // Good Friday
      '2026-04-04', // Easter Saturday
      '2026-04-05', // Easter Sunday
      '2026-04-06', // Easter Monday
      '2026-04-25', // Anzac Day
      '2026-06-08'  // King's Birthday (Second Monday in June)
    ]);

    let work = [];
    let isFirstLoad = true;

    function isWeekend(d){ return d.getDay()===0||d.getDay()===6; }
    function iso(d){ return d.toISOString().slice(0,10); }
    function dayName(d){ return d.toLocaleDateString('en-AU',{weekday:'long'}); }
    function fmtDisplay(isoDate){ const d=new Date(isoDate); return d.toLocaleDateString('en-AU',{day:'2-digit',month:'2-digit',year:'2-digit'}); }

    // Show status message
    function showStatus(message, type = 'success') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type} show`;
      setTimeout(() => {
        status.classList.remove('show');
      }, 3000);
    }

    // Fixed date parsing function to handle DD/MM/YY format from CSV
    function parseDDMMYY(txt){
      txt = txt.replace(/"/g, '').trim();
      const parts = txt.split('/');
      if(parts.length !== 3) return null;
      
      const [dd, mm, yy] = parts;
      if(!dd || !mm || !yy) return null;
      
      const YYYY = yy.length === 2 ? (parseInt(yy) > 50 ? '19' + yy : '20' + yy) : yy;
      return `${YYYY}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`;
    }

    function randHours(){ 
      const r=Math.random(); 
      if(r<0.1) return 6; 
      if(r<0.3) return 7; 
      if(r<0.7) return 8; 
      if(r<0.9) return 9; 
      return 10; 
    }

    // Save data to embedded script tag
    function save(){ 
      try {
        const dataElement = document.getElementById('workLogData');
        const data = JSON.stringify({work, isFirstLoad: false});
        dataElement.textContent = data;
        console.log('Data saved to embedded script tag');
      } catch(e) {
        console.warn('Save failed:', e);
        showStatus('Save failed: ' + e.message, 'error');
      }
    }
    
    // Load data from embedded script tag
    function load(){
      try {
        const dataElement = document.getElementById('workLogData');
        const dataText = dataElement.textContent.trim();
        
        if(dataText) {
          const saved = JSON.parse(dataText);
          work = saved.work || [];
          isFirstLoad = saved.isFirstLoad !== false;
          
          if(work.length === 0) {
            initializeEmptyLog();
          }
          console.log('Data loaded from embedded script tag, entries:', work.length);
          return;
        }
      } catch(e) {
        console.warn('Load failed:', e);
      }
      
      // Fallback to initialize empty log
      initializeEmptyLog();
    }

    function initializeEmptyLog(){
      work = [];
      const start = new Date('2025-07-01'), end = new Date('2026-06-30');
      
      for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)){
        const isoDate = iso(d), dn = dayName(d);
        let type = '', hours = 0, km = 0, notes = '';
        
        if(isWeekend(d)){
          notes = 'Weekend';
        } else if(nswHolidays.has(isoDate)){
          type = 'Public Holiday';
          notes = 'Public Holiday';
        } else {
          // Leave empty for user input
          notes = '';
        }
        
        work.push({date: isoDate, day: dn, type, hours, km, notes});
      }
      save();
    }

    function genLog(){
      // Generate random data for all working days except public holidays and annual leave
      work.forEach(entry => {
        if(!isWeekend(new Date(entry.date)) && !nswHolidays.has(entry.date) && entry.type !== 'Annual Leave') {
          // Random assignment logic - first visit of week gets client visit
          const d = new Date(entry.date);
          const weekStart = new Date(d);
          weekStart.setDate(d.getDate() - d.getDay() + 1); // Monday of this week
          
          let hasClientVisitThisWeek = false;
          for(let checkDate = new Date(weekStart); checkDate < d; checkDate.setDate(checkDate.getDate() + 1)) {
            const checkIso = iso(checkDate);
            const existingEntry = work.find(e => e.date === checkIso);
            if(existingEntry && existingEntry.type === 'Client Visit') {
              hasClientVisitThisWeek = true;
              break;
            }
          }
          
          if(!hasClientVisitThisWeek && Math.random() < 0.3) { // 30% chance for client visit if none this week
            entry.type = 'Client Visit';
            entry.hours = 0;
            entry.km = 60;
            entry.notes = 'Client Visit';
          } else {
            entry.type = 'WFH';
            entry.hours = randHours();
            entry.km = 0;
            entry.notes = 'Work from home';
          }
        }
      });
      
      render(); 
      updateSummary(); 
      save();
      showStatus('Random data generated successfully');
    }

    function updateSummary(){
      const totalWfh = work.reduce((s,d) => s + (d.type === 'WFH' ? d.hours : 0), 0);
      const visits = work.filter(d => d.type === 'Client Visit').length;
      const totalKm = work.reduce((s,d) => s + (d.km || 0), 0);
      const days = work.filter(d => d.type === 'WFH' || d.type === 'Client Visit').length;

      document.getElementById('totalWfh').textContent = totalWfh.toFixed(1);
      document.getElementById('totalVisits').textContent = visits;
      document.getElementById('totalKm').textContent = totalKm.toFixed(1) + ' km';
      document.getElementById('totalDays').textContent = days;
    }

    function onCellChange(i, field, el){
      const v = el.value;
      if(field === 'date'){
        const isoD = parseDDMMYY(v);
        if(isoD){ 
          work[i].date = isoD; 
          work[i].day = dayName(new Date(isoD)); 
        }
      }
      else if(field === 'type'){
        work[i].type = v;
        if(v === 'Client Visit'){ 
          work[i].km = work[i].km || 60; 
          work[i].hours = 0; 
          work[i].notes = work[i].notes || 'Client Visit';
        }
        if(v === 'WFH'){ 
          work[i].hours = work[i].hours || randHours(); 
          work[i].km = 0; 
          work[i].notes = work[i].notes || 'Work from home';
        }
        if(v === 'Public Holiday'){ 
          work[i].hours = 0; 
          work[i].km = 0; 
          work[i].notes = 'Public Holiday';
        }
        if(v === 'Annual Leave'){ 
          work[i].hours = 0; 
          work[i].km = 0; 
          work[i].notes = 'Annual Leave';
        }
      }
      else if(field === 'hours'){ work[i].hours = parseFloat(v) || 0; }
      else if(field === 'km'){ work[i].km = parseFloat(v) || 0; }
      else if(field === 'notes'){ work[i].notes = v; }
      
      render(); 
      updateSummary(); 
      save();
    }

    function createCell(val, i, field){
      if(field === 'type'){
        const opts = ['', 'WFH', 'Client Visit', 'Public Holiday', 'Annual Leave'];
        let s = `<select onchange="onCellChange(${i},'type',this)">`;
        opts.forEach(o => s += `<option value="${o}"${o === val ? ' selected' : ''}>${o}</option>`);
        return s + '</select>';
      }
      if(field === 'date'){
        return `<input type="text" value="${fmtDisplay(val)}" onchange="onCellChange(${i},'date',this)">`;
      }
      if(field === 'hours' || field === 'km'){
        return `<input type="number" step="0.1" min="0" value="${val || ''}" onchange="onCellChange(${i},'${field}',this)">`;
      }
      return `<input type="text" value="${val || ''}" onchange="onCellChange(${i},'${field}',this)">`;
    }

    function render(){
      const body = document.getElementById('body'); 
      body.innerHTML = '';
      let lastMonth = '';
      
      work.forEach((r, i) => {
        const d = new Date(r.date);
        const month = d.toLocaleDateString('en-AU', {month: 'long', year: 'numeric'});
        
        if(month !== lastMonth){ 
          body.insertAdjacentHTML('beforeend', `<tr class="month-header"><td colspan="6">${month}</td></tr>`); 
          lastMonth = month; 
        }
        
        let cls = '';
        if(r.type === 'WFH') cls = 'wfh';
        if(r.type === 'Client Visit') cls = 'client';
        if(r.type === 'Public Holiday') cls = 'holiday';
        if(r.type === 'Annual Leave') cls = 'annual-leave';
        
        body.insertAdjacentHTML('beforeend',
          `<tr class="${cls}">` +
          `<td>${createCell(r.date, i, 'date')}</td>` +
          `<td>${r.day}</td>` +
          `<td>${createCell(r.type, i, 'type')}</td>` +
          `<td>${createCell(r.hours, i, 'hours')}</td>` +
          `<td>${createCell(r.km, i, 'km')}</td>` +
          `<td><input type="text" value="${r.notes || ''}" onchange="onCellChange(${i},'notes',this)"></td>` +
          `</tr>`
        );
      });
      
      const tw = work.reduce((s, d) => s + (d.type === 'WFH' ? d.hours : 0), 0).toFixed(1);
      const tk = work.reduce((s, d) => s + (d.km || 0), 0).toFixed(1);
      body.insertAdjacentHTML('beforeend',
        `<tr class="totals-row"><td colspan="3"><strong>TOTALS</strong></td><td><strong>${tw}</strong></td><td><strong>${tk}</strong></td><td><strong>FY25-26</strong></td></tr>`
      );
    }

    function regenerate(){ 
      genLog();
    }

    // Modal functions
    function showClearModal(){
      document.getElementById('clearModal').style.display = 'block';
    }

    function hideClearModal(){
      document.getElementById('clearModal').style.display = 'none';
    }

    function confirmClear(){
      initializeEmptyLog();
      render();
      updateSummary();
      hideClearModal();
      showStatus('All data cleared successfully');
    }

    // Click outside modal to close
    window.onclick = function(event) {
      const modal = document.getElementById('clearModal');
      if (event.target === modal) {
        hideClearModal();
      }
    }

    // Save file function - creates a new HTML file with current data
    function saveToFile() {
      try {
        // Get the current HTML content
        const htmlContent = document.documentElement.outerHTML;
        
        // Create blob and download
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'work-log-fy25-26-saved.html';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        
        showStatus('File saved successfully! Open the downloaded file to continue working.');
      } catch (error) {
        console.error('Save file error:', error);
        showStatus('Failed to save file: ' + error.message, 'error');
      }
    }

    // CSV import function
    function importCSV(e){
      const file = e.target.files[0]; 
      if(!file) return;
      
      const debug = document.getElementById('debug');
      debug.style.display = 'block';
      debug.innerHTML = 'Starting CSV import...';
      
      const reader = new FileReader();
      reader.onload = function(evt){
        try {
          const text = evt.target.result;
          debug.innerHTML += '<br>File read successfully. Length: ' + text.length;
          
          const lines = text.split(/\r?\n/).filter(l => l.trim());
          debug.innerHTML += '<br>Lines found: ' + lines.length;
          
          if (lines.length === 0) {
            debug.innerHTML += '<br>ERROR: No lines found in CSV';
            return;
          }
          
          const header = lines.shift();
          debug.innerHTML += '<br>Header: ' + header;
          
          const headerFields = parseCSVLine(header);
          debug.innerHTML += '<br>Header fields: ' + JSON.stringify(headerFields);
          
          const fieldIndex = {};
          headerFields.forEach((field, i) => {
            const cleanField = field.replace(/"/g, '').trim();
            fieldIndex[cleanField] = i;
          });
          
          debug.innerHTML += '<br>Field mapping: ' + JSON.stringify(fieldIndex);
          
          work = [];
          let successCount = 0;
          let errorCount = 0;
          
          lines.forEach((line, lineNum) => {
            if (!line.trim()) return;
            
            try {
              const cols = parseCSVLine(line);
              
              const dateStr = cols[fieldIndex['Date']] ? cols[fieldIndex['Date']].replace(/"/g, '').trim() : '';
              const parsedDate = parseDDMMYY(dateStr);
              
              if (!parsedDate) {
                debug.innerHTML += `<br>Warning: Could not parse date "${dateStr}" on line ${lineNum + 2}`;
                errorCount++;
                return;
              }
              
              const entry = {
                date: parsedDate,
                day: cols[fieldIndex['Day']] ? cols[fieldIndex['Day']].replace(/"/g, '').trim() : '',
                type: cols[fieldIndex['Type']] ? cols[fieldIndex['Type']].replace(/"/g, '').trim() : '',
                hours: parseFloat(cols[fieldIndex['WFH Hours']] || 0) || 0,
                km: parseFloat(cols[fieldIndex['Travel KM']] || 0) || 0,
                notes: cols[fieldIndex['Notes']] ? cols[fieldIndex['Notes']].replace(/"/g, '').trim() : ''
              };
              
              work.push(entry);
              successCount++;
              
            } catch (err) {
              debug.innerHTML += `<br>Error parsing line ${lineNum + 2}: ${err.message}`;
              errorCount++;
            }
          });
          
          debug.innerHTML += `<br>Import complete: ${successCount} entries imported, ${errorCount} errors`;
          
          if (successCount > 0) {
            save(); 
            render(); 
            updateSummary();
            debug.innerHTML += '<br>Data saved and display updated';
            showStatus(`CSV imported: ${successCount} entries`);
          }
          
          e.target.value = '';
          
          setTimeout(() => {
            debug.style.display = 'none';
          }, 5000);
          
        } catch (err) {
          debug.innerHTML += '<br>FATAL ERROR: ' + err.message;
          console.error('CSV Import Error:', err);
          showStatus('CSV import failed: ' + err.message, 'error');
        }
      };
      
      reader.onerror = function(err) {
        debug.innerHTML += '<br>File read error: ' + err;
        showStatus('File read error', 'error');
      };
      
      reader.readAsText(file);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      
      result.push(current);
      return result;
    }

    function exportCSV(){
      const hdr = ['Date', 'Day', 'Type', 'WFH Hours', 'Travel KM', 'Notes'];
      const lines = [hdr.join(',')];
      work.forEach(r => {
        lines.push([
          `"${fmtDisplay(r.date)}"`,
          `"${r.day}"`,
          `"${r.type}"`,
          r.hours || 0,
          r.km || 0,
          `"${r.notes}"`
        ].join(','));
      });
      const blob = new Blob([lines.join('\n')], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = 'work-log-fy25-26.csv'; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(url);
      showStatus('CSV exported successfully');
    }

    // Initialize
    load(); 
    render(); 
    updateSummary();
  </script>
  
  <!-- Footer credit -->
  <footer style="
    position: fixed;
    bottom: 16px;
    right: 16px;
    font-size: 12px;
    color: #666;
    z-index: 1000;
  ">
    © 2025 Damian Choi - All Rights Reserved.
  </footer>
</body>